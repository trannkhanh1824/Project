<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>D3 â€“ Salary by Experience, Company Size, and Year</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }

    #header {
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      color: white;
      position: relative;
    }

    #header h2, #header h3 {
      color: black;
    }

    .axis path,
    .axis line {
      stroke: #aaa;
    }

    .legend text {
      font-size: 12px;
    }

    #controls {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* =====================
       TOOLTIP
    ====================== */
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.95);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      pointer-events: none;
      opacity: 0;
      z-index: 10000;
      transition: opacity 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      min-width: 220px;
    }

    .tooltip-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      padding-bottom: 6px;
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }

    .tooltip-label {
      color: #aaa;
    }

    .tooltip-value {
      font-weight: bold;
      color: #4facfe;
    }
  </style>
</head>

<body>

<div id="header">
  <h2>How Company Size Pays Differently by Experience Level (Over Time)</h2>
  <h3>Mean salary (USD) by experience level and company size, shown per year.</h3>
</div>

<div id="controls">
  <label for="yearSlider"><strong>Year:</strong></label>
  <input type="range" id="yearSlider" />
  <span id="yearLabel"></span>
</div>

<svg width="900" height="450"></svg>

<!-- Tooltip -->
<div class="tooltip" id="tooltip"></div>

<script>
const svg = d3.select("svg");
const tooltip = d3.select("#tooltip");

const margin = { top: 40, right: 180, bottom: 60, left: 80 };
const width = +svg.attr("width") - margin.left - margin.right;
const height = +svg.attr("height") - margin.top - margin.bottom;

const g = svg.append("g")
  .attr("transform", `translate(${margin.left},${margin.top})`);

const x0 = d3.scaleBand().paddingInner(0.2).range([0, width]);
const x1 = d3.scaleBand().padding(0.1);
const y = d3.scaleLinear().range([height, 0]);

const experienceLevels = ["EN", "MI", "SE", "EX"];
const companySizes = ["S", "M", "L"];

const color = d3.scaleOrdinal()
  .domain(companySizes)
  .range(d3.schemeTableau10);

const xAxis = g.append("g")
  .attr("transform", `translate(0,${height})`)
  .attr("class", "axis");

const yAxis = g.append("g")
  .attr("class", "axis");

d3.csv("/resources/salaries.csv", d3.autoType).then(data => {

  const dataByYear = {};

  const rolled = d3.rollups(
    data,
    v => d3.mean(v, d => d.salary_in_usd),
    d => d.work_year,
    d => d.experience_level,
    d => d.company_size
  );

  rolled.forEach(([year, exps]) => {
    dataByYear[year] = [];
    exps.forEach(([exp, sizes]) => {
      sizes.forEach(([size, salary]) => {
        dataByYear[year].push({
          experience: exp,
          company_size: size,
          salary: salary
        });
      });
    });
  });

  const years = Object.keys(dataByYear).sort();

  d3.select("#yearSlider")
    .attr("min", 0)
    .attr("max", years.length - 1)
    .attr("value", years.length - 1)
    .on("input", function () {
      update(years[this.value]);
    });

  function update(year) {
    d3.select("#yearLabel").text(year);
    const dataYear = dataByYear[year];

    x0.domain(experienceLevels);
    x1.domain(companySizes).range([0, x0.bandwidth()]);
    y.domain([0, d3.max(dataYear, d => d.salary)]).nice();

    xAxis.call(d3.axisBottom(x0));
    yAxis.call(d3.axisLeft(y).tickFormat(d => `$${d / 1000}k`));

    const groups = g.selectAll(".exp-group")
      .data(experienceLevels)
      .join("g")
      .attr("class", "exp-group")
      .attr("transform", d => `translate(${x0(d)},0)`);

    groups.selectAll("rect")
      .data(exp => dataYear.filter(d => d.experience === exp))
      .join("rect")
      .attr("x", d => x1(d.company_size))
      .attr("width", x1.bandwidth())
      .attr("fill", d => color(d.company_size))
      .on("mouseover", (event, d) => {
        tooltip
          .style("opacity", 1)
          .html(`
            <div class="tooltip-title">Salary Details</div>
            <div class="tooltip-row"><span class="tooltip-label">Year</span><span class="tooltip-value">${year}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">Experience</span><span class="tooltip-value">${d.experience}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">Company Size</span><span class="tooltip-value">${d.company_size}</span></div>
            <div class="tooltip-row"><span class="tooltip-label">Mean Salary</span><span class="tooltip-value">$${d3.format(",")(Math.round(d.salary))}</span></div>
          `);
      })
      .on("mousemove", event => {
        tooltip
          .style("left", (event.pageX + 15) + "px")
          .style("top", (event.pageY - 28) + "px");
      })
      .on("mouseout", () => tooltip.style("opacity", 0))
      .transition()
      .duration(500)
      .attr("y", d => y(d.salary))
      .attr("height", d => height - y(d.salary));
  }

  const legend = svg.append("g")
    .attr("transform", `translate(${margin.left + width + 40},${margin.top})`);

  companySizes.forEach((size, i) => {
    const row = legend.append("g")
      .attr("transform", `translate(0, ${i * 20})`);

    row.append("rect")
      .attr("width", 14)
      .attr("height", 14)
      .attr("fill", color(size));

    row.append("text")
      .attr("x", 20)
      .attr("y", 12)
      .text(size === "S" ? "Small" : size === "M" ? "Medium" : "Large");
  });

  update(years[years.length - 1]);
});
</script>

</body>
</html>
